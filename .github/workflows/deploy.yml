# .github/workflows/deploy.yml
name: Auto Deploy

on:
  push:
    branches:
      - master  # срабатывает на пуш в мастер

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Клонируем репозиторий (необязательно, если нужен только ssh)
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Подключаемся к серверу и выполняем команды
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}        # IP сервера
          username: deploy                      # юзер на сервере
          key: ${{ secrets.SSH_PRIVATE_KEY }}  # приватный ключ (добавить в Secrets)
          port: 22                              # порт SSH
          script: |
            echo "=== Pull latest code from master ==="
            cd /opt/shefport
            git fetch --all
            git reset --hard origin/master

            echo "=== Stop existing containers ==="
            docker compose down

            echo "=== Build and start containers ==="
            docker compose up -d --build

            echo "=== Clean unused Docker images ==="
            docker image prune -af

            echo "=== Deployment finished successfully ==="
